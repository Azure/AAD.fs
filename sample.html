<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>sample</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="Eugene Tolmachev">

    <link rel="stylesheet" id="theme_link" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/4.3.1/materia/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

    <link type="text/css" rel="stylesheet" href="https://Azure.github.io/AAD.fs/content/navbar-fixed-right.css" />
    <link type="text/css" rel="stylesheet" href="https://Azure.github.io/AAD.fs/content/fsdocs-default.css" />
    <link type="text/css" rel="stylesheet" href="https://Azure.github.io/AAD.fs/content/fsdocs-custom.css" />
    <script type="text/javascript" src="https://Azure.github.io/AAD.fs/content/fsdocs-tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!-- BEGIN SEARCH BOX: this adds support for the search box -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/JavaScript-autoComplete/1.0.4/auto-complete.css" />
    <!-- END SEARCH BOX: this adds support for the search box -->
    
</head>

<body>
    <nav class="navbar navbar-expand-md navbar-light bg-secondary fixed-right" id="fsdocs-menu">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <a href="https://Azure.github.io/AAD.fs/"><img id="fsdocs-logo" src="https://raw.githubusercontent.com/Azure/AAD.fs/master/docs/img/logo.png" /></a>
            <ul class="navbar-nav">
                <li class="nav-header">Links</li>
                <li class="nav-item" id="fsdocs-license-link"><a class="nav-link" href="https://github.com/Azure/blob/master/LICENSE.md">License</a></li>
                <li class="nav-item" id="fsdocs-release-notes-link"><a class="nav-link" href="https://github.com/Azure/blob/master/RELEASE_NOTES.md">Release Notes</a></li>
                <li class="nav-item" id="fsdocs-repository-link"><a class="nav-link" href="https://github.com/Azure/AAD.fs/">Source Repository</a></li>
                <li class="nav-header">
  Documentation
</li>             
<li class="nav-item">
  <a class="nav-link" href="https://Azure.github.io/AAD.fs/sample.html">
    sample
  </a>
</li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <div class="masthead">
            <h3 class="muted"><a href="https://Azure.github.io/AAD.fs/">AAD.fs</a></h3>
        </div>
        <hr />
        <div class="container" id="fsdocs-content">
            <h2><a name="The-sample" class="anchor" href="#The-sample">The sample</a></h2>
<p>The example implements authorization using <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/howto-add-app-roles-in-azure-ad-apps">Azure Application Roles</a>. The sample application can be found in your Azure Active Directory once provisioned:</p>
<ul>
<li><code>dotnet fake build -t registerSample</code></li>
</ul>
<p>For simplicity, the sample uses service principals as identities for the Requesting Party. The registration creates following items in the AD:</p>
<ul>
<li><code>aad-sample-admin</code> service principal (Requesting Party)</li>
<li><code>aad-sample-reader</code> service principal (Requesting Party)</li>
<li><code>aad-sample-writer</code> service principal (Requesting Party)</li>
<li><code>aad-fs-sample</code> application (Resource Server) and corresponging Enterprise Application to manage application role assignments</li>
</ul>
<blockquote>
<p>Note: All the identitifiers will have a random suffix added.</p>
</blockquote>
<p><code>aad-sample</code> will have following AppRoles defined:</p>
<ul>
<li><code>Admin</code> with <code>*/*</code> value</li>
<li><code>Reader</code> with <code>items/r</code> value</li>
<li><code>Writer</code> with <code>items/w</code> value</li>
</ul>
<p>Once provisioned you can find these roles in the application's manifest, it will look something like this:</p>
<p><img src="content/manifest_roles.png" alt="appRoles" /></p>
<p>Requesting Party service principals will have the corresponding roles assigned, which you can check in the Enterprise Application's <code>Users and Groups</code> blade:</p>
<p><img src="content/assignments.png" alt="assignments" /></p>
<h2><a name="Authoring-the-roles" class="anchor" href="#Authoring-the-roles">Authoring the roles</a></h2>
<p>The role values can be anything you need. The example here demonstrates the capability of the library to deal with patterns and wildcards:</p>
<p>A "pattern" means that we can expect a structure in the value, like "items/r" or "items.r" - <code>/</code> is the default separator, but the character is configurable - use <code>PartProtector.mkNew</code> instead of <code>mkDefault</code> if you need to change it. </br>
Use <code>*</code> wildcard in any segment of the role value to make any demand match that part of the pattern, for example <code>items/*</code> in the role value will match the demands like <code>items/r</code>, <code>items/w</code>, etc. </br>
<code>*/*</code> means that the identity with that claim in the token will have access to APIs that demand <code>items</code>, <code>fiddles/play</code>, <code>cats/herd</code>, etc with or w/o any 2nd (verb) segment.</p>
<p>Complex demands can be expressed by combining the patterns with <code>Any</code> and <code>All</code>, for example:</p>
<ul>
<li><code>All [Pattern ["A";"1"]; Pattern ["B";"2"]]</code> will only match if both <code>A/1</code> and <code>B/2</code> are present among the token claims.</li>
</ul>
<h2><a name="Implementing-Resource-Server" class="anchor" href="#Implementing-Resource-Server">Implementing Resource Server</a></h2>
<p>The full source code for this sample is in <code>AAD.tasks.Test/ResourceServers.fs</code>, but here are the important ingredients:</p>
<pre class="fssnip highlighted"><code lang="fsharp"><span onmouseout="hideTip(event, 'fs16', 16)" onmouseover="showTip(event, 'fs16', 16)" class="id">task</span> <span class="pn">{</span>
    <span class="k">let!</span> <span class="id">protector</span> <span class="pn">:</span> <span onmouseout="hideTip(event, 'fs17', 17)" onmouseover="showTip(event, 'fs17', 17)" class="id">PartProtector</span> <span class="o">=</span> 
        <span onmouseout="hideTip(event, 'fs17', 18)" onmouseover="showTip(event, 'fs17', 18)" class="id">PartProtector</span><span class="pn">.</span><span onmouseout="hideTip(event, 'fs18', 19)" onmouseover="showTip(event, 'fs18', 19)" class="id">mkDefault</span> <span onmouseout="hideTip(event, 'fs9', 20)" onmouseover="showTip(event, 'fs9', 20)" class="id">httpClient</span> <span onmouseout="hideTip(event, 'fs13', 21)" onmouseover="showTip(event, 'fs13', 21)" class="id">audience</span> <span onmouseout="hideTip(event, 'fs14', 22)" onmouseover="showTip(event, 'fs14', 22)" class="id">authority</span>
        
    <span class="k">let</span> <span class="id">read</span> <span class="pn">:</span> <span onmouseout="hideTip(event, 'fs19', 23)" onmouseover="showTip(event, 'fs19', 23)" class="id">HttpHandler</span> <span class="o">=</span>
        <span class="id">protector</span><span class="pn">.</span><span class="id">Verify</span> <span class="pn">(</span><span class="k">fun</span> <span class="id">ctx</span> <span class="k">-&gt;</span> <span class="id">Task</span><span class="pn">.</span><span class="id">FromResult</span> <span class="o">&lt;|</span> <span onmouseout="hideTip(event, 'fs20', 24)" onmouseover="showTip(event, 'fs20', 24)" class="id">Pattern</span> <span class="pn">[</span><span class="s">&quot;items&quot;</span><span class="pn">;</span> <span class="s">&quot;r&quot;</span><span class="pn">]</span><span class="pn">)</span>
                         <span class="pn">(</span><span class="k">fun</span> <span class="id">token</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs21', 25)" onmouseover="showTip(event, 'fs21', 25)" class="id">text</span> <span class="s">&quot;Read!&quot;</span><span class="pn">)</span>

    <span class="k">let</span> <span class="id">write</span> <span class="pn">:</span> <span onmouseout="hideTip(event, 'fs19', 26)" onmouseover="showTip(event, 'fs19', 26)" class="id">HttpHandler</span> <span class="o">=</span>
        <span class="id">protector</span><span class="pn">.</span><span class="id">Verify</span> <span class="pn">(</span><span class="k">fun</span> <span class="id">ctx</span> <span class="k">-&gt;</span> <span class="id">Task</span><span class="pn">.</span><span class="id">FromResult</span> <span class="o">&lt;|</span> <span onmouseout="hideTip(event, 'fs20', 27)" onmouseover="showTip(event, 'fs20', 27)" class="id">Pattern</span> <span class="pn">[</span><span class="s">&quot;items&quot;</span><span class="pn">;</span> <span class="s">&quot;w&quot;</span><span class="pn">]</span><span class="pn">)</span>
                         <span class="pn">(</span><span class="k">fun</span> <span class="id">token</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs21', 28)" onmouseover="showTip(event, 'fs21', 28)" class="id">text</span> <span class="s">&quot;Written!&quot;</span><span class="pn">)</span>
        
    <span class="k">return</span> 
        <span onmouseout="hideTip(event, 'fs22', 29)" onmouseover="showTip(event, 'fs22', 29)" class="id">choose</span> <span class="pn">[</span>
          <span onmouseout="hideTip(event, 'fs23', 30)" onmouseover="showTip(event, 'fs23', 30)" class="id">HEAD</span> <span class="pn">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs24', 31)" onmouseover="showTip(event, 'fs24', 31)" class="id">route</span> <span class="s">&quot;/&quot;</span> <span class="pn">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs25', 32)" onmouseover="showTip(event, 'fs25', 32)" class="id">Successful</span><span class="pn">.</span><span onmouseout="hideTip(event, 'fs26', 33)" onmouseover="showTip(event, 'fs26', 33)" class="id">NO_CONTENT</span>
          <span onmouseout="hideTip(event, 'fs27', 34)" onmouseover="showTip(event, 'fs27', 34)" class="id">GET</span> <span class="pn">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs24', 35)" onmouseover="showTip(event, 'fs24', 35)" class="id">route</span> <span class="s">&quot;/&quot;</span> <span class="pn">&gt;</span><span class="o">=&gt;</span> <span class="id">read</span>
          <span onmouseout="hideTip(event, 'fs28', 36)" onmouseover="showTip(event, 'fs28', 36)" class="id">PUT</span> <span class="pn">&gt;</span><span class="o">=&gt;</span> <span onmouseout="hideTip(event, 'fs24', 37)" onmouseover="showTip(event, 'fs24', 37)" class="id">route</span> <span class="s">&quot;/&quot;</span> <span class="pn">&gt;</span><span class="o">=&gt;</span> <span class="id">write</span>
          <span onmouseout="hideTip(event, 'fs29', 38)" onmouseover="showTip(event, 'fs29', 38)" class="id">RequestErrors</span><span class="pn">.</span><span onmouseout="hideTip(event, 'fs24', 39)" onmouseover="showTip(event, 'fs24', 39)" class="id">NOT_FOUND</span> <span class="s">&quot;&quot;</span>
        <span class="pn">]</span>
<span class="pn">}</span>
</code></pre>
<p>As you can see:</p>
<ul>
<li>all the tokens that <code>protector</code> handles are issued for a specific <code>audience</code> - our <code>aad-fs-sample</code></li>
<li>the functions that return the demands for a given handler are asynchronous to facilitate potential IO based on the context of the request.</li>
<li><code>read</code> HttpHandler demands access with a token that has a claim in one of [<code>role</code>, <code>roles</code> or <code>scp</code>] that matches the pattern <code>items/r</code></li>
<li><code>write</code> HttpHandler demands access with a token that has a claim that matches the pattern <code>items/w</code></li>
</ul>
<p>And as mentioned above, <code>Admin</code> with its <code>*/*</code> value will meet both of those demands.</p>
<h2><a name="Requesting-the-token" class="anchor" href="#Requesting-the-token">Requesting the token</a></h2>
<p>On the Requesting Party side, we need to tell the AD that we need the appRoles assigned to our principals mapped to the token claims.
We do that by specifying our <code>Application URI</code> as a scope, in case of the registerd sample it will look something like: <code>api://{clientid}/.default</code>, where the <code>/.default</code> suffix is a special identifier that tells AD to figure which role(s) the user has in the application instead of requesting one specific role.
The samples use <a href="https://github.com/AzureAD/microsoft-authentication-library-for-dotnet">MSAL</a> to obtain and refresh the token as needed.</p>
<h2><a name="Passing-the-token-with-a-call" class="anchor" href="#Passing-the-token-with-a-call">Passing the token with a call</a></h2>
<p>Considering that the token is refreshed periodically, <code>AsyncRequestor</code> or <code>TaskRequestor</code> can be useful to ensure a token is obtained and associated it with each request.</p>

            <div class="fsdocs-tip" id="fs1">namespace System</div>
<div class="fsdocs-tip" id="fs2">Multiple items<br />namespace FSharp<br /><br />--------------------<br />namespace Microsoft.FSharp</div>
<div class="fsdocs-tip" id="fs3">Multiple items<br />namespace FSharp.Control<br /><br />--------------------<br />namespace Microsoft.FSharp.Control</div>
<div class="fsdocs-tip" id="fs4">namespace FSharp.Control.Tasks</div>
<div class="fsdocs-tip" id="fs5">module V2<br /><br />from FSharp.Control.Tasks</div>
<div class="fsdocs-tip" id="fs6">module ContextInsensitive<br /><br />from FSharp.Control.Tasks.V2</div>
<div class="fsdocs-tip" id="fs7">namespace Giraffe</div>
<div class="fsdocs-tip" id="fs8">namespace AAD</div>
<div class="fsdocs-tip" id="fs9">val httpClient : Net.Http.HttpClient</div>
<div class="fsdocs-tip" id="fs10">namespace System.Net</div>
<div class="fsdocs-tip" id="fs11">namespace System.Net.Http</div>
<div class="fsdocs-tip" id="fs12">Multiple items<br />type HttpClient =<br />&#160;&#160;inherit HttpMessageInvoker<br />&#160;&#160;new : unit -&gt; unit + 2 overloads<br />&#160;&#160;member CancelPendingRequests : unit -&gt; unit<br />&#160;&#160;member DeleteAsync : requestUri: string -&gt; Task&lt;HttpResponseMessage&gt; + 3 overloads<br />&#160;&#160;member Dispose : disposing: bool -&gt; unit<br />&#160;&#160;member GetAsync : requestUri: string -&gt; Task&lt;HttpResponseMessage&gt; + 7 overloads<br />&#160;&#160;member GetByteArrayAsync : requestUri: string -&gt; Task&lt;byte []&gt; + 3 overloads<br />&#160;&#160;member GetStreamAsync : requestUri: string -&gt; Task&lt;Stream&gt; + 3 overloads<br />&#160;&#160;member GetStringAsync : requestUri: string -&gt; Task&lt;string&gt; + 3 overloads<br />&#160;&#160;member PatchAsync : requestUri: string * content: HttpContent -&gt; Task&lt;HttpResponseMessage&gt; + 3 overloads<br />&#160;&#160;...<br /><br />--------------------<br />Net.Http.HttpClient() : Net.Http.HttpClient<br />Net.Http.HttpClient(handler: Net.Http.HttpMessageHandler) : Net.Http.HttpClient<br />Net.Http.HttpClient(handler: Net.Http.HttpMessageHandler, disposeHandler: bool) : Net.Http.HttpClient</div>
<div class="fsdocs-tip" id="fs13">val audience : string list</div>
<div class="fsdocs-tip" id="fs14">val authority : Uri</div>
<div class="fsdocs-tip" id="fs15">Multiple items<br />type Uri =<br />&#160;&#160;interface ISerializable<br />&#160;&#160;new : serializationInfo: SerializationInfo * streamingContext: StreamingContext -&gt; unit + 6 overloads<br />&#160;&#160;member Canonicalize : unit -&gt; unit<br />&#160;&#160;member CheckSecurity : unit -&gt; unit<br />&#160;&#160;member Equals : comparand: obj -&gt; bool<br />&#160;&#160;member Escape : unit -&gt; unit<br />&#160;&#160;member GetComponents : components: UriComponents * format: UriFormat -&gt; string<br />&#160;&#160;member GetHashCode : unit -&gt; int<br />&#160;&#160;member GetLeftPart : part: UriPartial -&gt; string<br />&#160;&#160;member GetObjectData : serializationInfo: SerializationInfo * streamingContext: StreamingContext -&gt; unit<br />&#160;&#160;...<br /><br />--------------------<br />Uri(uriString: string) : Uri<br />Uri(uriString: string, uriKind: UriKind) : Uri<br />Uri(baseUri: Uri, relativeUri: string) : Uri<br />Uri(baseUri: Uri, relativeUri: Uri) : Uri</div>
<div class="fsdocs-tip" id="fs16">val task : FSharp.Control.Tasks.TaskBuilder.TaskBuilderV2</div>
<div class="fsdocs-tip" id="fs17">Multiple items<br />module PartProtector<br /><br />from AAD<br /><br />--------------------</div>
<div class="fsdocs-tip" id="fs18">val mkDefault : httpClient:Net.Http.HttpClient -&gt; audiences:#seq&lt;Audience&gt; -&gt; authority:Uri -&gt; Threading.Tasks.Task&lt;PartProtector&gt;</div>
<div class="fsdocs-tip" id="fs19">type HttpHandler = HttpFunc -&gt; HttpFunc</div>
<div class="fsdocs-tip" id="fs20">union case Demand.Pattern: string list -&gt; Demand</div>
<div class="fsdocs-tip" id="fs21">val text : str:string -&gt; HttpHandler</div>
<div class="fsdocs-tip" id="fs22">val choose : handlers:HttpHandler list -&gt; next:HttpFunc -&gt; HttpFunc</div>
<div class="fsdocs-tip" id="fs23">val HEAD : HttpHandler</div>
<div class="fsdocs-tip" id="fs24"></div>
<div class="fsdocs-tip" id="fs25">module Successful<br /><br />from Giraffe.HttpStatusCodeHandlers</div>
<div class="fsdocs-tip" id="fs26">val NO_CONTENT : HttpHandler</div>
<div class="fsdocs-tip" id="fs27">val GET : HttpHandler</div>
<div class="fsdocs-tip" id="fs28">val PUT : HttpHandler</div>
<div class="fsdocs-tip" id="fs29">module RequestErrors<br /><br />from Giraffe.HttpStatusCodeHandlers</div>

        </div>

        <!-- BEGIN SEARCH BOX: this adds support for the search box -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/JavaScript-autoComplete/1.0.4/auto-complete.css" />
        <script type="text/javascript">var fsdocs_search_baseurl = 'https://Azure.github.io/AAD.fs/';</script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.8/lunr.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/JavaScript-autoComplete/1.0.4/auto-complete.min.js"></script>
        <script type="text/javascript" src="https://Azure.github.io/AAD.fs/content/fsdocs-search.js"></script>
        <!-- END SEARCH BOX: this adds support for the search box -->
    </div>

    <div style="text-align: center">(c) Microsoft Corporation. All rights reserved.</div>
</body>

</html>